# SequenceBaseSig
[Git Source](https://github.com/0xsequence/wallet-contracts/blob/09c54e74c2803b55df32c0470f8b0e0ebe86f4c9/contracts/modules/commons/submodules/auth/SequenceBaseSig.sol)

**Author:**
Agustin Aguilar (aa@horizon.io)

A Solidity implementation for handling signatures in the Sequence protocol.


## State Variables
### FLAG_SIGNATURE

```solidity
uint256 internal constant FLAG_SIGNATURE = 0
```


### FLAG_ADDRESS

```solidity
uint256 internal constant FLAG_ADDRESS = 1
```


### FLAG_DYNAMIC_SIGNATURE

```solidity
uint256 internal constant FLAG_DYNAMIC_SIGNATURE = 2
```


### FLAG_NODE

```solidity
uint256 internal constant FLAG_NODE = 3
```


### FLAG_BRANCH

```solidity
uint256 internal constant FLAG_BRANCH = 4
```


### FLAG_SUBDIGEST

```solidity
uint256 internal constant FLAG_SUBDIGEST = 5
```


### FLAG_NESTED

```solidity
uint256 internal constant FLAG_NESTED = 6
```


## Functions
### subdigest

Generates a subdigest for the input digest (unique for this wallet and network).


```solidity
function subdigest(bytes32 _digest) internal view returns (bytes32);
```
**Parameters**

|Name|Type|Description|
|----|----|-----------|
|`_digest`|`bytes32`|The input digest to generate the subdigest from.|

**Returns**

|Name|Type|Description|
|----|----|-----------|
|`<none>`|`bytes32`|bytes32 The subdigest generated from the input digest.|


### _leafForAddressAndWeight

Generates the leaf for an address and weight.

The leaf is generated by concatenating the address and weight.


```solidity
function _leafForAddressAndWeight(address _addr, uint96 _weight) internal pure returns (bytes32);
```
**Parameters**

|Name|Type|Description|
|----|----|-----------|
|`_addr`|`address`|The address to generate the leaf for.|
|`_weight`|`uint96`|The weight to generate the leaf for.|

**Returns**

|Name|Type|Description|
|----|----|-----------|
|`<none>`|`bytes32`|bytes32 The leaf generated from the address and weight.|


### _leafForHardcodedSubdigest

Generates the leaf for a hardcoded subdigest.

The leaf is generated by hashing 'Sequence static digest:\n' and the subdigest.


```solidity
function _leafForHardcodedSubdigest(bytes32 _subdigest) internal pure returns (bytes32);
```
**Parameters**

|Name|Type|Description|
|----|----|-----------|
|`_subdigest`|`bytes32`|The subdigest to generate the leaf for.|

**Returns**

|Name|Type|Description|
|----|----|-----------|
|`<none>`|`bytes32`|bytes32 The leaf generated from the hardcoded subdigest.|


### _leafForNested

Generates the leaf for a nested tree node.

The leaf is generated by hashing 'Sequence nested config:\n', the node, the threshold and the weight.


```solidity
function _leafForNested(bytes32 _node, uint256 _threshold, uint256 _weight) internal pure returns (bytes32);
```
**Parameters**

|Name|Type|Description|
|----|----|-----------|
|`_node`|`bytes32`|The root of the node to generate the leaf for.|
|`_threshold`|`uint256`|The internal threshold of the tree.|
|`_weight`|`uint256`|The external weight of the tree.|

**Returns**

|Name|Type|Description|
|----|----|-----------|
|`<none>`|`bytes32`|bytes32 The leaf generated from the nested tree.|


### recoverBranch

Returns the weight and root of a signature branch.

If the signature contains a hardcoded subdigest, and it matches the input digest, then the weight is set to 2 ** 256 - 1.


```solidity
function recoverBranch(bytes32 _subdigest, bytes calldata _signature)
    internal
    view
    returns (uint256 weight, bytes32 root);
```
**Parameters**

|Name|Type|Description|
|----|----|-----------|
|`_subdigest`|`bytes32`|The digest to verify the signature against.|
|`_signature`|`bytes`|The signature branch to recover.|

**Returns**

|Name|Type|Description|
|----|----|-----------|
|`weight`|`uint256`|The total weight of the recovered signatures.|
|`root`|`bytes32`|The root hash of the recovered configuration.|


### recover

Returns the threshold, weight, root, and checkpoint of a signature.

To verify the signature, the weight must be greater than or equal to the threshold, and the root
must match the expected `imageHash` of the wallet.


```solidity
function recover(bytes32 _subdigest, bytes calldata _signature)
    internal
    view
    returns (uint256 threshold, uint256 weight, bytes32 imageHash, uint256 checkpoint);
```
**Parameters**

|Name|Type|Description|
|----|----|-----------|
|`_subdigest`|`bytes32`|The digest to verify the signature against.|
|`_signature`|`bytes`|The signature to recover.|

**Returns**

|Name|Type|Description|
|----|----|-----------|
|`threshold`|`uint256`|The minimum weight required for the signature to be valid.|
|`weight`|`uint256`|The total weight of the recovered signatures.|
|`imageHash`|`bytes32`|The root hash of the recovered configuration|
|`checkpoint`|`uint256`|The checkpoint of the signature.|


## Errors
### InvalidNestedSignature

```solidity
error InvalidNestedSignature(bytes32 _hash, address _addr, bytes _signature);
```

### InvalidSignatureFlag

```solidity
error InvalidSignatureFlag(uint256 _flag);
```

